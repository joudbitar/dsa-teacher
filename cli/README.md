# @dsa/cli

DSA Lab command-line tool for testing and submitting solutions locally.

## Installation

### Install from this monorepo (macOS/Linux/WSL)

```bash
make install-cli      # run from repository root
dsa --version
```

Need to pull the latest sources directly? Use `make install-cli-remote`.

### Install from npm (Recommended) ðŸš€

```
npm install -g @dsa/cli
```

After installation, verify the CLI is available:

```
dsa --version
```

#### Updating

Already installed the CLI? Grab the latest version with:

```
npm update -g @dsa/cli
```

To check what version you have locally:

```
npm ls -g @dsa/cli --depth=0
```

### Alternative: Install from source step-by-step

If you want to run each step manually instead of using the Makefile:

```bash
# 1. Install and set up pnpm
npm install -g pnpm
pnpm setup
source ~/.zshrc  # or restart terminal

# 2. Install dependencies and build
cd cli
pnpm install
pnpm build

# 3. Link CLI globally
pnpm link --global

# 4. Verify
dsa --version
```

### Helper scripts

- POSIX shell: `scripts/install-cli.sh`
- Windows PowerShell: `cli/scripts/install.ps1`

### Troubleshooting

If `dsa` command is not found after installation:

1. **Restart your terminal**
2. **Or add to PATH:**
   ```bash
   export PATH="$(npm config get prefix)/bin:$PATH"
   ```

See `INSTALL.md` for detailed troubleshooting guide.

### Publishing to npm

To cut a new release:

```bash
cd cli
pnpm install
pnpm test        # when available
npm version <patch|minor|major>
pnpm publish --access public
git push --follow-tags
```

Rebuilds run automatically through the `prepack` script before publishing.

## Commands

### `dsa test`

Runs tests and displays results with color-coded output.

```bash
dsa test
```

**What it does:**

1. Reads `dsa.config.json`
2. Executes test command (e.g., `node tests/run.js`)
3. Parses `.dsa-report.json`
4. Displays results

### `dsa submit`

Submits test results to the DSA Lab API and updates dashboard.

```bash
dsa submit
```

**What it does:**

1. Runs `dsa test` internally to get latest results
2. Checks git status (warns if uncommitted changes)
3. Captures current git commit SHA
4. Reads project credentials from config
5. POSTs results to `/api/submissions` with Bearer token
6. Displays confirmation message with link to dashboard

### `dsa hint`

Displays hints from the `HINTS.md` file in the challenge repository.

```bash
dsa hint
```

**What it does:**

1. Reads `dsa.config.json` to find the project root
2. Looks for `HINTS.md` in the project root
3. If a test report exists, shows hints for the current challenge
4. Otherwise, displays all hints from the file
5. Formats and displays hints with color-coded output

**Features:**

- Automatically detects the current challenge you're working on
- If `HINTS.md` is organized by challenge (e.g., `## Challenge 1: push`), shows only relevant hints
- Falls back to showing all hints if no challenge-specific section is found
- Supports markdown formatting (headers, code blocks, lists)

## Configuration

Projects contain `dsa.config.json` (auto-generated by API):

```json
{
  "projectId": "uuid",
  "projectToken": "secure-token",
  "moduleId": "stack",
  "language": "TypeScript",
  "testCommand": "node tests/run.js",
  "reportFile": ".dsa-report.json"
}
```

## Usage Example

```bash
# Clone a challenge repo
git clone <github-repo-url>
cd repo-name

# Install dependencies
npm install

# Run tests
dsa test

# Get hints for the current challenge
dsa hint

# Make changes, commit, and submit
git add .
git commit -m "Implement push method"
dsa submit
```

## Test Report Format

The test runner generates `.dsa-report.json`:

```json
{
  "moduleId": "stack",
  "summary": "3/5 tests passed",
  "pass": false,
  "cases": [
    {
      "subchallengeId": "push",
      "passed": true
    },
    {
      "subchallengeId": "pop",
      "passed": false,
      "message": "Expected 5, got undefined"
    }
  ]
}
```

## Error Handling

- **Missing config**: "Not a DSA project. Run this command inside a cloned challenge repo."
- **Invalid config**: "Invalid dsa.config.json: ..."
- **Missing report**: "No report file found. Run `dsa test` first."
- **Invalid token**: "Invalid project token"
- **Network error**: "Failed to connect to API"

## Development

```bash
# Install dependencies
npm install

# Build
npm run build

# Test locally
node dist/index.js test
```

## Architecture

```
cli/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # CLI router
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ test.ts        # Test command
â”‚   â”‚   â”œâ”€â”€ submit.ts      # Submit command
â”‚   â”‚   â””â”€â”€ hint.ts        # Hint command
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ loadConfig.ts  # Config loader
â”‚       â”œâ”€â”€ runCommand.ts  # Shell command executor
â”‚       â”œâ”€â”€ parseReport.ts # Report parser
â”‚       â”œâ”€â”€ http.ts        # API client
â”‚       â””â”€â”€ git.ts         # Git utilities
â””â”€â”€ types/
    â””â”€â”€ report.d.ts        # TypeScript types
```
