# CLI Build Guide

## Overview

The DSA Lab CLI is a command-line tool that allows students to:
1. **Test** their solutions locally (`dsa test`)
2. **Submit** test results to the dashboard (`dsa submit`)

## Architecture

```
cli/
├── bin/dsa              # Entry point (shebang script)
├── src/
│   ├── index.ts         # Main CLI router (parses argv, routes to commands)
│   ├── commands/
│   │   ├── test.ts      # `dsa test` command
│   │   └── submit.ts    # `dsa submit` command
│   └── lib/
│       ├── loadConfig.ts    # Loads dsa.config.json
│       ├── runCommand.ts    # Executes shell commands
│       ├── parseReport.ts   # Parses .dsa-report.json
│       ├── http.ts          # HTTP client for API calls
│       └── git.ts           # Git status/commit SHA
└── types/
    └── report.d.ts      # TypeScript type definitions
```

## How It Works

### Command Flow: `dsa test`

1. **Entry Point** (`bin/dsa` → `src/index.ts`)
   - Parses command-line arguments
   - Routes to `test` command handler

2. **Load Config** (`lib/loadConfig.ts`)
   - Searches for `dsa.config.json` in current directory and parents
   - Returns: `{ projectId, projectToken, moduleId, language, apiUrl, testCommand, reportFile }`

3. **Run Tests** (`lib/runCommand.ts`)
   - Executes the test command (e.g., `node tests/run.js`)
   - Captures stdout, stderr, and exit code
   - Optionally streams output to terminal

4. **Parse Report** (`lib/parseReport.ts`)
   - Reads `.dsa-report.json` (generated by test runner)
   - Validates structure matches `DSAReport` schema
   - Returns structured report object

5. **Display Results** (`commands/test.ts`)
   - Shows colored output (✓ green for pass, ✗ red for fail)
   - Prints summary and details
   - Returns report for use by `submit` command

### Command Flow: `dsa submit`

1. **Run Tests First** (`commands/submit.ts`)
   - Internally calls `test` command to get latest results
   - Ensures tests are up-to-date before submission

2. **Check Git Status** (`lib/git.ts`)
   - Verifies working tree is clean (or prompts user)
   - Captures current commit SHA

3. **Load Config** (`lib/loadConfig.ts`)
   - Gets project ID and auth token

4. **POST to API** (`lib/http.ts`)
   - Sends submission to `POST /api/submissions`
   - Headers: `Authorization: Bearer <projectToken>`
   - Body: `{ projectId, details: <DSAReport>, commitSha }`

5. **Display Confirmation**
   - Shows success message with dashboard link

## Data Flow

### Configuration File (`dsa.config.json`)

```json
{
  "projectId": "uuid",
  "projectToken": "abc123...xyz789",
  "moduleId": "stack",
  "language": "TypeScript",
  "apiUrl": "https://dsa-lab.vercel.app",
  "testCommand": "node tests/run.js",
  "reportFile": ".dsa-report.json"
}
```

### Test Report (`.dsa-report.json`)

Generated by the test runner in each project repo:

```json
{
  "moduleId": "stack",
  "summary": "4/5 tests passed",
  "pass": false,
  "cases": [
    {
      "subchallengeId": "create-class",
      "passed": true
    },
    {
      "subchallengeId": "push",
      "passed": true
    },
    {
      "subchallengeId": "pop",
      "passed": false,
      "message": "Expected 10, received undefined"
    }
  ]
}
```

### API Submission Payload

```json
{
  "projectId": "uuid",
  "details": {
    "moduleId": "stack",
    "summary": "4/5 tests passed",
    "pass": false,
    "cases": [...]
  },
  "commitSha": "abc123def456"
}
```

## Getting Started

### Step 1: Install Dependencies

```bash
cd cli
pnpm install
```

You'll need to add these dependencies:

```bash
pnpm add commander          # For CLI argument parsing
pnpm add chalk              # For colored terminal output
pnpm add execa              # For running shell commands (better than child_process)
pnpm add readline-sync      # For user prompts (optional, for confirmations)
```

### Step 2: Set Up TypeScript

Create `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "node",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### Step 3: Implementation Order

Build in this order (each builds on the previous):

1. **Types** (`types/report.d.ts`) - Already defined ✅
2. **HTTP Client** (`lib/http.ts`) - Simple fetch wrapper
3. **Git Utils** (`lib/git.ts`) - Git status/commit SHA
4. **Config Loader** (`lib/loadConfig.ts`) - Read and validate config
5. **Command Runner** (`lib/runCommand.ts`) - Execute shell commands
6. **Report Parser** (`lib/parseReport.ts`) - Parse JSON report
7. **Test Command** (`commands/test.ts`) - Orchestrate test flow
8. **Submit Command** (`commands/submit.ts`) - Orchestrate submit flow
9. **Main Entry** (`src/index.ts`) - CLI router
10. **Bin Script** (`bin/dsa`) - Entry point

### Step 4: Build and Test

```bash
# Build TypeScript
pnpm build

# Test locally (from a project directory)
node dist/index.js test
node dist/index.js submit
```

### Step 5: Make Executable

```bash
chmod +x bin/dsa
```

## Key Implementation Details

### 1. Config Loading (`loadConfig.ts`)

- Search up directory tree for `dsa.config.json`
- Use `fs.existsSync()` and `path.resolve()`
- Validate required fields
- Throw descriptive errors if missing

### 2. Command Execution (`runCommand.ts`)

- Use `execa` for better error handling
- Stream output to terminal for real-time feedback
- Return `{ stdout, stderr, exitCode }`

### 3. Report Parsing (`parseReport.ts`)

- Read `.dsa-report.json` from config-specified path
- Validate against `DSAReport` interface
- Handle missing/malformed files gracefully

### 4. HTTP Client (`http.ts`)

- Use native `fetch` (Node 18+)
- Handle network errors
- Return typed response object

### 5. Git Utils (`git.ts`)

- Use `execa` to run `git status --porcelain`
- Use `execa` to run `git rev-parse HEAD`
- Handle non-git directories gracefully

### 6. CLI Router (`index.ts`)

- Use `commander` or `minimist` for argument parsing
- Register `test` and `submit` commands
- Handle unknown commands with helpful error

### 7. Colored Output

- Use `chalk` for colors:
  - Green `✓` for pass
  - Red `✗` for fail
  - Yellow for warnings
  - Blue for info

## Testing Strategy

### Manual Testing

1. Create a test project directory with `dsa.config.json`
2. Create a mock `.dsa-report.json`
3. Test each command individually
4. Test error cases (missing config, invalid JSON, etc.)

### Example Test Setup

```bash
mkdir test-project
cd test-project

# Create mock config
cat > dsa.config.json << EOF
{
  "projectId": "test-uuid",
  "projectToken": "test-token",
  "moduleId": "stack",
  "language": "TypeScript",
  "apiUrl": "http://localhost:3000",
  "testCommand": "echo 'Tests passed'",
  "reportFile": ".dsa-report.json"
}
EOF

# Create mock report
cat > .dsa-report.json << EOF
{
  "moduleId": "stack",
  "summary": "3/5 tests passed",
  "pass": false,
  "cases": [
    { "subchallengeId": "create-class", "passed": true },
    { "subchallengeId": "push", "passed": true },
    { "subchallengeId": "pop", "passed": true },
    { "subchallengeId": "peek", "passed": false },
    { "subchallengeId": "size", "passed": false }
  ]
}
EOF

# Test commands
dsa test
dsa submit
```

## Error Handling

Handle these cases gracefully:

- **Missing config**: "Not a DSA project. Run this command inside a cloned challenge repo."
- **Missing report**: "No report file found. Run `dsa test` first."
- **Invalid JSON**: "Invalid report format. Check test runner output."
- **Git not clean**: Prompt user to confirm before submitting
- **API errors**: Show user-friendly error messages
- **Network errors**: "Failed to connect to API. Check your internet connection."

## Next Steps

1. Start with the simplest utility (`http.ts`)
2. Build up to more complex commands
3. Test incrementally as you build
4. Use TypeScript types to catch errors early
5. Add helpful error messages throughout

## Resources

- [Commander.js docs](https://github.com/tj/commander.js)
- [Chalk docs](https://github.com/chalk/chalk)
- [Execa docs](https://github.com/sindresorhus/execa)
- [Node.js fetch API](https://nodejs.org/api/globals.html#fetch)

